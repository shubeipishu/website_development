# ============================================================
# Nginx 默认配置文件
# 作为反向代理和静态文件服务器
# ============================================================

server {
    # 监听 80 端口
    listen 80;
    # server_name _; 表示匹配所有请求的主机名
    server_name _;

    # 根目录指向静态文件目录
    root /usr/share/nginx/html;
    index index.html;

    # ========================================================
    # 静态文件路由
    # ========================================================
    # 访问 / 及其子路径时，指向静态文件目录
    location / {
        # 先尝试匹配文件，再尝试目录，最后回退到 index.html
        try_files $uri $uri/ /index.html;
    }

    # 确保 graph-platform 子项目的正确加载
    location /apps/graph-platform/ {
        # 尝试匹配文件或目录
        try_files $uri $uri/ /apps/graph-platform/index.html;
    }

    # ========================================================
    # API 反向代理路由
    # ========================================================
    # 访问 /api/ 开头的请求，转发到 backend 容器
    location /api/ {
        # 使用 Docker 内置 DNS 解析器 (127.0.0.11)
        # valid=30s 表示 DNS 缓存有效期
        resolver 127.0.0.11 valid=30s;
        
        # 使用变量实现延迟解析，避免启动时 backend 尚未就绪
        set $upstream_backend http://backend:8000;
        proxy_pass $upstream_backend;

        # 设置代理头信息
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 禁用缓冲以支持流式响应
        proxy_buffering off;

        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # ========================================================
    # 安全设置
    # ========================================================
    # 禁止访问隐藏文件 (.git, .env 等)
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
}
